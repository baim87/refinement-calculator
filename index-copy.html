<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MuhRO Refinement Calculator</title>

    <meta name="description" content="Quickly calculate your Ragnarok Online (MuhRO) item refinements for weapons, armor, and accessories. Compare crafting vs buying materials to find the cheapest upgrade path.">
    <meta name="keywords" content="Ragnarok Online, MuhRO, refinement calculator, RO calculator, item upgrade, RO tools">
    <meta name="author" content="HolySoul88">
    <link rel="icon" type="image/x-icon" href="./favicon.ico" />

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="application/ld+json">
        {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "MuhRO Refinement Calculator",
        "url": "https://baim87.github.io/ragnarok-refinement-calculator/",
        "applicationCategory": "GameApplication",
        "operatingSystem": "Web",
        "description": "Quickly calculate your Ragnarok Online (MuhRO) item refinements for weapons, armor, and accessories.",
        "creator": {
            "@type": "Person",
            "name": "HolySoul88"
        }
        }
    </script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1WV7XEWYPE"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-1WV7XEWYPE');
    </script>

    <style>
        :root {
            --primary-bg: #1a1a2e;
            --card-bg: #ffffff;
            --muhro-blue: #0f3460;
            --muhro-accent: #e94560;
            --text-main: #333333;
            --text-muted: #666666;
            --border-color: #e1e1e1;
            --success-color: #28a745;
            --success-bg: rgba(40, 167, 69, 0.08);
        }

        body { 
            font-family: 'Nunito', sans-serif; 
            background-color: var(--primary-bg); 
            background-image: radial-gradient(circle at top, #16213e, #1a1a2e);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .app-container { width: 100%; max-width: 700px; }
        .calculator-card { background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .header { text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--border-color); }
        .header h1 { font-family: 'Montserrat', sans-serif; color: var(--muhro-blue); margin: 0; font-size: 1.6rem; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; }
        .header span { color: var(--muhro-accent); font-weight: 600; }
        .help-link { display: inline-block; margin-top: 5px; font-size: 0.85rem; color: var(--muhro-accent); text-decoration: none; border-bottom: 1px dashed var(--muhro-accent); transition: opacity 0.2s; cursor: pointer; }
        .help-link:hover { opacity: 0.7; }
        
        .form-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .form-group { flex: 1; margin-bottom: 20px; }
        .form-row .form-group { margin-bottom: 0; }
        
        label { display: block; font-family: 'Montserrat', sans-serif; font-weight: 600; margin-bottom: 8px; color: var(--muhro-blue); font-size: 0.95rem; }
        select, input[type="number"], input[type="text"] { width: 100%; padding: 10px 12px; border: 2px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-family: 'Nunito', sans-serif; font-size: 1rem; font-weight: 600; transition: border-color 0.2s; }
        select:focus, input:focus { outline: none; border-color: var(--muhro-accent); }
        
        .checkbox-group { display: flex; align-items: center; margin-bottom: 12px; background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); }
        .checkbox-group input { width: 18px; height: 18px; margin-right: 12px; cursor: pointer; }
        .checkbox-group label { margin-bottom: 0; font-family: 'Nunito', sans-serif; cursor: pointer; color: var(--text-main); font-size: 0.9rem; }
        
        .market-prices-box { background: #eef2f5; padding: 20px; border-radius: 6px; border: 1px dashed var(--muhro-blue); margin-bottom: 20px; display: none; }
        .market-prices-box .title { font-family: 'Montserrat', sans-serif; font-weight: 700; color: var(--muhro-blue); font-size: 0.9rem; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .market-label-link { color: var(--muhro-blue); text-decoration: none; border-bottom: 1px dashed var(--muhro-blue); transition: opacity 0.2s; font-weight: 700; }
        .market-label-link:hover { opacity: 0.7; }
        
        .results-wrapper { display: flex; gap: 20px; margin-top: 15px; }
        .results-col { flex: 1; }
        .results-title { font-family: 'Montserrat', sans-serif; font-weight: 700; color: var(--muhro-blue); font-size: 0.9rem; margin-bottom: 10px; border-bottom: 2px solid var(--border-color); padding-bottom: 5px; }
        
        .material-row { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 10px 12px; margin-bottom: 6px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 0.9rem; }
        .item-icon { width: 24px; height: 24px; vertical-align: middle; margin-right: 8px; border: 1px solid var(--border-color); border-radius: 4px; background-color: #f4f4f4; }
        .material-name-container { display: flex; align-items: center; flex-grow: 1; font-weight: 600; color: var(--text-main); font-size: 0.9rem; }
        
        hr { border: 0; border-top: 2px dashed var(--border-color); margin: 25px 0; }
        
        .other-tools { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px dashed var(--border-color); font-size: 0.9rem; color: var(--text-muted); }
        .other-tools a { display: inline-block; margin: 4px 8px; color: var(--muhro-blue); text-decoration: none; font-weight: 700; font-family: 'Montserrat', sans-serif; border-bottom: 1px dashed var(--muhro-blue); transition: color 0.2s, border-color 0.2s; }
        .other-tools a:hover { color: var(--muhro-accent); border-color: var(--muhro-accent); }
        
        .footer { text-align: center; margin-top: 20px; color: #a0a0b0; font-size: 0.85rem; }
        .footer .heart { color: var(--muhro-accent); font-size: 1.1rem; vertical-align: middle; }
        .footer .author { font-weight: 600; color: #ffffff; letter-spacing: 0.5px; }
        
        #logContainer { background: #fdfdfd; border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; max-height: 250px; overflow-y: auto; font-size: 0.85rem; margin-top: 15px; line-height: 1.6; color: var(--text-muted); }
        .log-entry { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .log-entry:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        
        .error-message { color: var(--muhro-accent); font-weight: 700; text-align: center; padding: 15px; background: #ffe5e5; border-radius: 6px; }

        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(15, 52, 96, 0.7); backdrop-filter: blur(4px); }
        .modal-content { background-color: var(--card-bg); margin: 8% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 550px; box-shadow: 0 15px 40px rgba(0,0,0,0.5); position: relative; animation: modalSlideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        .modal-close { position: absolute; top: 15px; right: 20px; color: var(--text-muted); font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .modal-close:hover { color: var(--muhro-accent); }
        .modal-title { font-family: 'Montserrat', sans-serif; color: var(--muhro-blue); margin-top: 0; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; font-size: 1.4rem; }
        .modal-body { font-size: 0.95rem; line-height: 1.6; color: var(--text-main); max-height: 60vh; overflow-y: auto; padding-right: 10px; }
        .modal-body::-webkit-scrollbar { width: 6px; }
        .modal-body::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .modal-body::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .modal-body::-webkit-scrollbar-thumb:hover { background: var(--muhro-accent); }
        .modal-body p { margin-bottom: 12px; }
        .modal-body h4 { color: var(--muhro-accent); margin-bottom: 5px; font-family: 'Montserrat', sans-serif; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="calculator-card">
        
        <div class="header">
            <h1>MuhRO <span>Refine Calc</span></h1>
            <a class="help-link" id="openHelpModal">How to use this calculator?</a>
        </div>

        <div id="loadingMessage" style="text-align: center; color: var(--muhro-blue); font-weight: bold; padding: 20px;">
            Loading database files...
        </div>
        
        <div id="mainControls" style="display: none;">
            <div class="form-row">
                <div class="form-group">
                    <label>Gear Type</label>
                    <select id="gearType" class="calc-input">
                        <option value="Weapon">Weapon</option>
                        <option value="Armor">Armor</option>
                        <option value="Shadow Weapon">Shadow Weapon</option>
                        <option value="Shadow Armor">Shadow Armor</option>
                    </select>
                </div>
                <div class="form-group" id="levelGroup">
                    <label>Gear Level</label>
                    <select id="gearLevel" class="calc-input">
                        <option value="1">Level 1</option>
                        <option value="2">Level 2</option>
                        <option value="3">Level 3</option>
                        <option value="4">Level 4</option>
                        <option value="5" selected>Level 5</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Current Refine</label>
                    <input type="number" id="currentRefine" class="calc-input" min="0" max="19" value="11">
                </div>
                <div class="form-group">
                    <label>Target Refine</label>
                    <input type="number" id="targetRefine" class="calc-input" min="1" max="20" value="20">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Probability Rule</label>
                    <select id="probLogic" class="calc-input">
                        <option value="Normal">Normal Probability</option>
                        <option value="Special">Special (Enriched / Cash) Probability</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="border-bottom: 1px dotted var(--text-muted); cursor: help; display: inline-block; padding-bottom: 2px;" title="The zeny required to click 'Refine' at the Blacksmith NPC">Cost per Refine (NPC Fee)</label>
                    <input type="text" inputmode="numeric" id="priceRefineFee" class="calc-input price-input-format" value="0" placeholder="e.g. 100,000">
                </div>
            </div>

            <div class="form-group" id="wrapMaterialStrat" style="display: none;">
                <label>Material Strategy</label>
                <select id="materialStrategy" class="calc-input">
                    </select>
            </div>

            <div class="checkbox-group" id="wrapBsb" style="display: none; border-color: var(--success-color); background: var(--success-bg);">
                <input type="checkbox" id="useBsb" class="calc-input" checked>
                <label for="useBsb" style="font-weight: 700; color: var(--muhro-blue);">Use Blacksmith's Blessing to prevent destruction</label>
            </div>

            <div class="checkbox-group" style="margin-top: 15px;">
                <input type="checkbox" id="breakdownMats" class="calc-input">
                <label for="breakdownMats">Compare Market Prices (Crafting vs Buying Directly)</label>
            </div>

            <div id="marketPricesConfig" class="market-prices-box">
                <div class="title">Market Price Configuration</div>
                
                <div class="form-row" style="margin-bottom: 15px; display: none;" id="wrapBaseGear">
                    <div class="form-group" style="margin-bottom:0; flex: 1;">
                        <label style="font-size: 0.85rem; display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                            <span title="The market price of your item at the Current Refine level to replace it if it breaks" style="border-bottom: 1px dotted var(--text-muted); cursor: help; font-weight: 700; color: var(--muhro-blue);">Base Gear Duplicate (at Current Refine)</span>
                        </label>
                        <input type="text" inputmode="numeric" id="priceBase" class="calc-input price-input-format" value="0">
                    </div>
                </div>

                <div id="marketDirectItemsWrapper" style="display: none;">
                    <hr style="border-top: 1px dashed #ccc; margin: 15px 0;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase;">Direct Materials (Buy Ready-to-Use)</div>
                    <div id="dynamicDirectPrices" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
                </div>

                <div id="marketRawItemsWrapper" style="display: none;">
                    <hr style="border-top: 1px dashed #ccc; margin: 15px 0;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase;">Raw Ingredients (For Crafting)</div>
                    <div id="dynamicRawPrices" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
                </div>
            </div>

            <div id="calculatorUI" style="display: none;">
                <hr>
                
                <div id="compareContainer" style="display:none; margin-bottom: 25px;">
                    <div class="results-title" style="text-align: center; border: none; font-size: 1.1rem; margin-bottom: 15px;">Cost Comparison Strategy</div>
                    <div style="display: flex; gap: 15px;">
                        <div id="optA_box" style="flex: 1; padding: 15px; border-radius: 8px; border: 2px solid var(--border-color); background: var(--card-bg); transition: all 0.3s;">
                            <div style="font-weight: 700; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; text-align: center;">Option A: Craft Materials</div>
                            <div id="optA_Total" style="font-size: 1.25rem; font-weight: 700; color: var(--muhro-blue); margin: 8px 0; text-align: center;">0 z</div>
                            <div id="optA_Breakdown" style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.6; margin-top: 10px;"></div>
                        </div>
                        <div id="optB_box" style="flex: 1; padding: 15px; border-radius: 8px; border: 2px solid var(--border-color); background: var(--card-bg); transition: all 0.3s;">
                            <div style="font-weight: 700; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; text-align: center;">Option B: Buy Directly</div>
                            <div id="optB_Total" style="font-size: 1.25rem; font-weight: 700; color: var(--muhro-blue); margin: 8px 0; text-align: center;">0 z</div>
                            <div id="optB_Breakdown" style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.6; margin-top: 10px;"></div>
                        </div>
                    </div>
                </div>

                <div class="results-wrapper">
                    <div class="results-col" id="directCol">
                        <div class="results-title">Expected Preparation Needed</div>
                        <div id="directMaterialsContainer"></div>
                    </div>
                    
                    <div class="results-col" id="rawCol" style="display: none;">
                        <div class="results-title">Recursive Crafting Breakdown</div>
                        <div id="rawMaterialsContainer"></div>
                    </div>
                </div>

                <label style="margin-top: 25px;">Refine Path Expected Actions</label>
                <div id="logContainer"></div>
            </div>
            <div class="other-tools">
                Check out my other tools:<br>
                <a href="https://baim87.github.io/ragnarok-grade-enhancing-calculator/" target="_blank">Grade Enhancing Calculator</a>
                <a href="https://baim87.github.io/ragnarok-consumable-calculator/" target="_blank">Consumable Calculator</a>
            </div>

        </div>

    </div>

    <div class="footer">
        Created with <span class="heart">&hearts;</span> by <span class="author">HolySoul88</span>
    </div>
</div>

<div id="helpModal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" id="closeHelpModal">&times;</span>
        <h2 class="modal-title">How to Use the Calculator</h2>
        <div class="modal-body">
            <p>This tool calculates the <strong>Prepared Expected Cost</strong> to refine an item based on official MuhRO probability rates, taking into account the built-in Pity system, item degradation, and recovery failures.</p>
            <h4>1. Select Your Gear</h4>
            <p>Choose your gear type and its weapon/armor level. For Shadow Gear, the level doesn't matter (max refinement is strictly capped at +10).</p>
            <h4>2. MuhRO Pity System</h4>
            <p>On MuhRO, every time a refinement fails, the next attempt gains a cumulative <strong>+10% success chance</strong>. The algorithm fully integrates this pity system, drastically reducing the total number of Expected Attempts required!</p>
            <h4>3. Dynamic Protection</h4>
            <p>The UI is smart: it physically looks ahead at the specific path you entered. If there is an actual risk of destruction between +7 and +15, a <strong>Blacksmith's Blessing</strong> checkbox will dynamically appear to protect it. If HD materials exist for your tier, the Material Strategy dropdown will appear allowing you to select them.</p>
            <h4>4. Range-Restricted Math</h4>
            <p>If your item breaks or drops below your <em>Current Refine</em> starting point, the tool will <strong>not</strong> recursively calculate the cost to build it back from +0 (which caused lower-tier ores to bleed into the calculation). Instead, it assumes you replace it with an identical item at your Current Refine level, adding `1x Base Gear Duplicate` to the cost sheet.</p>
        </div>
    </div>
</div>

<script>
    let probabilityData = [];
    let costsData = {};
    let rulesData = [];

    const bsbReqMap = {
        7: 1, 8: 2, 9: 4, 10: 4, 11: 7, 12: 11, 13: 16, 14: 22
    };

    Promise.all([
        $.getJSON('probability.json'),
        $.getJSON('rules.json'),
        $.getJSON('cost.json')
    ]).then(function(results) {
        probabilityData = results[0];
        rulesData = results[1];
        costsData = results[2];

        $('#loadingMessage').hide();
        $('#mainControls').fadeIn();
        initApp();
    }).catch(function(error) {
        console.error("Error loading JSON files:", error);
        $('#loadingMessage').html('<div class="error-message">Error loading database files. Make sure probability.json, rules.json, and cost.json are in the root directory.</div>');
    });

    function getExpectedAttemptsWithPity(baseRate) {
        if (baseRate >= 1.0) return 1;
        let expectedAttempts = 0;
        let cumulativeFailProb = 1.0;
        for (let i = 1; i <= 20; i++) {
            let currentRate = baseRate + (i - 1) * 0.10;
            if (currentRate >= 1.0) {
                expectedAttempts += i * cumulativeFailProb * 1.0;
                break;
            }
            expectedAttempts += i * cumulativeFailProb * currentRate;
            cumulativeFailProb *= (1.0 - currentRate);
        }
        return expectedAttempts;
    }

    function multiplyCost(costObj, multiplier) {
        let res = {};
        for(let k in costObj) res[k] = costObj[k] * multiplier;
        return res;
    }

    function addCost(a, b) {
        let res = {...a};
        for(let k in b) res[k] = (res[k] || 0) + b[k];
        return res;
    }

    function resolveBaseMaterials(itemName, amount = 1, breakdown = false) {
        let res = {};
        if (itemName === 'Zeny') { res['Zeny'] = amount; return res; }

        let skipRoughs = false;
        if (itemName === "Oridecon (984)" || itemName === "Elunium (985)") skipRoughs = true;

        if (breakdown && costsData[itemName] && !skipRoughs) {
            let recipe = costsData[itemName][0]; 
            for(let r of recipe) {
                let sub = resolveBaseMaterials(r.material, r.amount * amount, breakdown);
                res = addCost(res, sub);
            }
        } else {
            res[itemName] = amount;
        }
        return res;
    }

    function formatItemName(rawName, withIcon = true, explicitTip = null) {
        if (rawName === 'Zeny' || rawName.includes('Fee')) {
            return `<span style="font-weight: 700; color: var(--text-main);">${rawName}</span>`;
        }
        let match = rawName.match(/^(.*?)\s*\((\d+)\)$/);
        if (match) {
            let itemName = match[1];
            let itemId = match[2];
            let matDbLink = `https://flux.muhro.eu/?module=item&action=view&id=${itemId}`;
            let iconHtml = '';
            if (withIcon) {
                let matIconUrl = `https://flux.muhro.eu/data/zrenderer_cache/item%2Ficon%2F${itemId}.png`;
                iconHtml = `<img src="${matIconUrl}" class="item-icon" onerror="this.style.display='none'">`;
            }
            let tooltip = explicitTip ? explicitTip : `Click to check market price for ${itemName}`;
            return `
                <div class="material-name-container">
                    ${iconHtml}
                    <a href="${matDbLink}" class="market-label-link" target="_blank" title="${tooltip}">
                        ${itemName}
                    </a>
                </div>
            `;
        }
        return `<span style="font-weight: 700; color: var(--text-main);">${rawName}</span>`;
    }

    function getValidRules(L, baseGearType, level, probLogic, isShadowUI) {
        let rules = rulesData.filter(r => {
            if (r.gear !== baseGearType) return false;
            if (L < r.min_refine || L >= r.max_refine) return false; 
            
            if (isShadowUI) return r.is_shadow === true;
            return r.is_shadow === false && r.levels.includes(level);
        });

        let specificLogic = rules.filter(r => r.probability === probLogic);
        if (specificLogic.length > 0) return specificLogic;
        return rules;
    }

    function initApp() {
        $(document).on('input', '.price-input-format', function() {
            let rawValue = $(this).val().replace(/\D/g, ''); 
            if (rawValue !== '') $(this).val(parseInt(rawValue, 10).toLocaleString('en-US'));
            else $(this).val('');
        });

        $('#breakdownMats').on('change', function() {
            if ($(this).is(':checked')) $('#marketPricesConfig').slideDown(200);
            else $('#marketPricesConfig').slideUp(200);
        });

        $('#openHelpModal').on('click', function(e) { e.preventDefault(); $('#helpModal').fadeIn(200); });
        $('#closeHelpModal').on('click', function() { $('#helpModal').fadeOut(200); });
        $(window).on('click', function(e) { if ($(e.target).is('#helpModal')) $('#helpModal').fadeOut(200); });

        $('#gearType').on('change', function() {
            let type = $(this).val();
            let $lvl = $('#gearLevel');
            let $target = $('#targetRefine');
            let $current = $('#currentRefine');
            
            if (type.includes('Shadow')) {
                $('#levelGroup').slideUp();
                $target.attr('max', 10);
                $current.attr('max', 9);
                
                if (parseInt($current.val()) > 9) {
                    $current.val(0);
                    $target.val(10);
                } else if (parseInt($target.val()) > 10) {
                    $target.val(10);
                }
            } else {
                $('#levelGroup').slideDown();
                $target.attr('max', 20);
                $current.attr('max', 19);
                
                $lvl.empty();
                if (type === 'Weapon') {
                    [1,2,3,4,5].forEach(i => $lvl.append(`<option value="${i}">Level ${i}</option>`));
                    $lvl.val("5");
                } else if (type === 'Armor') {
                    [1,2].forEach(i => $lvl.append(`<option value="${i}">Level ${i}</option>`));
                    $lvl.val("2");
                }
            }
            calculate();
        });

        $('#currentRefine').on('change blur', function() {
            let type = $('#gearType').val();
            let maxCurrent = type.includes('Shadow') ? 9 : 19;
            let val = parseInt($(this).val());
            
            if (isNaN(val) || val < 0) {
                $(this).val(0);
            } else if (val > maxCurrent) {
                $(this).val(maxCurrent);
            }
            
            if(parseInt($(this).val()) >= parseInt($('#targetRefine').val())) {
                let safeTarget = Math.min(parseInt($(this).val()) + 1, type.includes('Shadow') ? 10 : 20);
                $('#targetRefine').val(safeTarget);
            }
            calculate();
        });

        $('#targetRefine').on('change blur', function() {
            let type = $('#gearType').val();
            let maxTarget = type.includes('Shadow') ? 10 : 20;
            let val = parseInt($(this).val());

            if (isNaN(val) || val < 1) $(this).val(1);
            if (val > maxTarget) $(this).val(maxTarget);
            
            if(parseInt($(this).val()) <= parseInt($('#currentRefine').val())) {
                let safeCurrent = Math.max(parseInt($(this).val()) - 1, 0);
                $('#currentRefine').val(safeCurrent);
            }
            calculate();
        });

        $(document).on('change input', '.calc-input', function() { calculate(); });

        calculate(); 
    }

    function calculate() {
        let type = $('#gearType').val();
        let level = parseInt($('#gearLevel').val()) || 1;
        let currentRefine = parseInt($('#currentRefine').val()) || 0;
        let target = parseInt($('#targetRefine').val());
        let probLogic = $('#probLogic').val();
        let showBreakdown = $('#breakdownMats').is(':checked');

        let isShadowUI = type.includes('Shadow');
        let baseGearType = type.includes('Weapon') ? 'Weapon' : 'Armor';

        $('#directMaterialsContainer').empty();
        $('#rawMaterialsContainer').empty();
        $('#logContainer').empty();
        
        if (showBreakdown) {
            $('#rawCol').show();
            $('#compareContainer').show();
        } else {
            $('#rawCol').hide();
            $('#compareContainer').hide();
        }

        if (isNaN(target) || target < 1) return;
        if (currentRefine >= target) return;

        let hasSafeOption = false;
        let hasBsbOption = false;
        let hasDestruction = false;

        for (let L = currentRefine; L < target; L++) {
            let probRow = probabilityData.find(p => p.level === (L + 1) && p.probability_logic === probLogic);
            let probKey = isShadowUI ? "Shadow Equipment" : `${baseGearType} (Lv ${level})`;
            let pRate = probRow ? probRow.rates[probKey] : 1.0;
            let canFail = (pRate !== "-" && pRate < 1.0);

            let rules = getValidRules(L, baseGearType, level, probLogic, isShadowUI);
            if (rules.length === 0) continue;

            let baseRule = rules.find(r => !r.item.includes("HD")) || rules[0];
            let stepCanDestroy = baseRule.penalty.includes("Destroyed");

            if (canFail && stepCanDestroy) {
                hasDestruction = true;
                if (L >= 7 && L <= 14 && !isShadowUI) {
                    hasBsbOption = true;
                }
            }
            if (canFail && rules.some(r => r.item.includes("HD"))) {
                hasSafeOption = true;
            }
        }

        // Material Strategy Dropdown
        let currentMatStrat = $('#materialStrategy').val();
        let stratSig = hasSafeOption.toString();
        
        if ($('#wrapMaterialStrat').data('sig') !== stratSig) {
            $('#wrapMaterialStrat').data('sig', stratSig);
            $('#materialStrategy').empty();

            if (hasSafeOption) $('#materialStrategy').append(`<option value="safe">Use Safe / HD Ores</option>`);
            $('#materialStrategy').append(`<option value="risk">Use Normal / Base Ores</option>`);

            if ($('#materialStrategy option[value="' + currentMatStrat + '"]').length > 0) {
                $('#materialStrategy').val(currentMatStrat);
            } else {
                $('#materialStrategy').val($('#materialStrategy option:first').val());
            }
        }
        
        if (hasSafeOption) $('#wrapMaterialStrat').slideDown(200);
        else $('#wrapMaterialStrat').slideUp(200);

        // BSB Checkbox
        if (hasBsbOption) $('#wrapBsb').slideDown(200);
        else {
            $('#wrapBsb').slideUp(200);
            $('#useBsb').prop('checked', false); 
        }

        let matStrategy = $('#materialStrategy').val() || 'risk';
        let useBsbChecked = $('#useBsb').is(':checked');

        let step_costs_dir = []; 
        let total_dir_fractional = {}; 
        let log = [];

        for (let L = currentRefine; L < target; L++) {
            
            let validRules = getValidRules(L, baseGearType, level, probLogic, isShadowUI);
            if (validRules.length === 0) {
                return renderError(`No valid material rule found for configuring ${type} Level ${level} from +${L} to +${L+1}.`); 
            }

            let probRow = probabilityData.find(p => p.level === (L + 1) && p.probability_logic === probLogic);
            if (!probRow) return renderError(`System Error: Missing Probability logic for +${L+1}.`);
            let probKey = isShadowUI ? "Shadow Equipment" : `${baseGearType} (Lv ${level})`;
            let pRate = probRow.rates[probKey];

            if (pRate === "-" || pRate === undefined || pRate <= 0) {
                return renderError(`Refining ${probKey} past +${L} is not possible according to official rates.`);
            }
            let canFail = pRate < 1.0;

            let hdRules = validRules.filter(r => r.item.includes("HD"));
            let nonHdRules = validRules.filter(r => !r.item.includes("HD"));
            let bestNonHd = nonHdRules.length > 0 ? nonHdRules[0] : validRules[0];
            let bestHd = hdRules.length > 0 ? hdRules[0] : bestNonHd;

            let rule;
            let applyBsb = false;

            if (useBsbChecked && canFail && bestNonHd.penalty.includes("Destroyed") && L >= 7 && L <= 14 && !isShadowUI) {
                rule = bestNonHd;
                applyBsb = true;
            } else if (matStrategy === 'safe') {
                if (bestHd.penalty.includes("Destroyed") && !bestNonHd.penalty.includes("Destroyed")) {
                    rule = bestNonHd;
                } else {
                    rule = bestHd;
                }
            } else {
                rule = bestNonHd;
            }

            let expected_attempts = getExpectedAttemptsWithPity(pRate);
            let fails_avg = expected_attempts - 1;
            
            let matCostDir = resolveBaseMaterials(rule.item, 1, false);
            matCostDir['Refine Attempt'] = 1; 
            
            if (applyBsb && bsbReqMap[L]) {
                matCostDir["Blacksmith's Blessing (6635)"] = bsbReqMap[L];
            }
            
            let step_cost_dir = {};
            let logPenalty = "";

            if (!canFail) {
                step_cost_dir = addCost(matCostDir, multiplyCost(matCostDir, fails_avg));
                logPenalty = `<span style="color:var(--text-muted);">None (100% Success)</span>`;
            } else if (applyBsb) {
                step_cost_dir = addCost(matCostDir, multiplyCost(matCostDir, fails_avg));
                logPenalty = `<em style="color:var(--success-color);">None (Protected by BSB)</em>`;
            } else if (rule.penalty.includes("Destroyed")) {
                // Instantly penalizes 1 Base Gear without recursing to +0
                let fail_dir = addCost(matCostDir, {"Base Gear (Before Refining)": 1});
                step_cost_dir = addCost(matCostDir, multiplyCost(fail_dir, fails_avg));
                logPenalty = `<em style="color:var(--muhro-accent);">${rule.penalty}</em>`;
            } else if (rule.penalty.includes("Decreased by 1")) {
                let dropL = L - 1;
                let fail_dir = {...matCostDir};
                if (dropL < currentRefine) {
                    fail_dir = addCost(fail_dir, {"Base Gear (Before Refining)": 1});
                } else {
                    fail_dir = addCost(fail_dir, step_costs_dir[dropL]);
                }
                step_cost_dir = addCost(matCostDir, multiplyCost(fail_dir, fails_avg));
                logPenalty = `<em style="color:var(--muhro-accent);">${rule.penalty}</em>`;
            } else if (rule.penalty.includes("Decreased by 3")) {
                let rec = {};
                for (let i = L - 3; i < L; i++) {
                    if (i < currentRefine) {
                        if (i === L - 3) rec = addCost(rec, {"Base Gear (Before Refining)": 1});
                    } else {
                        rec = addCost(rec, step_costs_dir[i]);
                    }
                }
                let fail_dir = addCost(matCostDir, rec);
                step_cost_dir = addCost(matCostDir, multiplyCost(fail_dir, fails_avg));
                logPenalty = `<em style="color:var(--muhro-accent);">${rule.penalty}</em>`;
            } else {
                step_cost_dir = addCost(matCostDir, multiplyCost(matCostDir, fails_avg));
                logPenalty = `<span style="color:var(--text-muted);">None</span>`;
            }
            
            step_costs_dir[L] = step_cost_dir;
            total_dir_fractional = addCost(total_dir_fractional, step_cost_dir);
            
            let logItemName = rule.item.replace(/\s*\(\d+\)$/, '');
            let stepClicks = step_cost_dir['Refine Attempt'] || 1;
            
            if (applyBsb) logItemName += ` + <span style="color:var(--success-color); font-size: 0.85rem;">[${bsbReqMap[L]}x BSB]</span>`;

            log.push(`<div class="log-entry" style="display:flex; flex-direction:column; gap:4px;">
                        <div><strong>+${L} &rarr; +${L+1}</strong> : Used <span style="font-weight:700;">${logItemName}</span> (Base Success: ${(pRate * 100).toFixed(0)}%)</div>
                        <div style="font-size: 0.85rem; color: var(--muhro-blue);"><strong>Expected Attempts:</strong> ~${stepClicks.toLocaleString(undefined, {maximumFractionDigits:1})} <span style="color:var(--text-muted); font-weight: normal;">(Includes Pity System & Recoveries)</span></div>
                        <small>Penalty on Fail: ${logPenalty}</small>
                        </div>`);
        }

        let prepared_dir = {};
        for (let k in total_dir_fractional) {
            if (k === 'Zeny') prepared_dir[k] = Math.round(total_dir_fractional[k]);
            else prepared_dir[k] = Math.ceil(total_dir_fractional[k]);
        }

        let pRefineFee = parseInt($('#priceRefineFee').val().replace(/,/g, '')) || 0;
        let totalAttempts = prepared_dir['Refine Attempt'] || 0;
        if (pRefineFee > 0 && totalAttempts > 0) {
            prepared_dir['NPC Refine Fee (Zeny)'] = totalAttempts * pRefineFee;
        }

        let total_raw = {};
        for (let k in prepared_dir) {
            if (k === 'Zeny' || k === 'Refine Attempt' || k === 'Base Gear (Before Refining)' || k === 'NPC Refine Fee (Zeny)') {
                total_raw = addCost(total_raw, { [k]: prepared_dir[k] });
            } else {
                let brokenDown = resolveBaseMaterials(k, prepared_dir[k], true);
                total_raw = addCost(total_raw, brokenDown);
            }
        }

        renderLists(prepared_dir, total_raw);
        
        if (showBreakdown) {
            let directKeys = Object.keys(prepared_dir).filter(k => k !== 'Zeny' && !k.includes('Fee') && k !== 'Refine Attempt' && !k.includes('Base Gear'));
            let rawKeys = Object.keys(total_raw).filter(k => k !== 'Zeny' && !k.includes('Fee') && k !== 'Refine Attempt' && !k.includes('Base Gear'));
            let strictlyRawKeys = rawKeys.filter(k => !directKeys.includes(k));

            let sig = directKeys.join() + "|" + strictlyRawKeys.join();
            if ($('#marketPricesConfig').data('sig') !== sig) {
                $('#marketPricesConfig').data('sig', sig);
                $('#dynamicDirectPrices').empty();
                $('#dynamicRawPrices').empty();

                directKeys.forEach(k => {
                    let safeKey = k.replace(/[^a-zA-Z0-9]/g, '');
                    $('#dynamicDirectPrices').append(`
                        <div class="form-group" style="margin-bottom:0;">
                            <label style="font-size: 0.85rem; display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                ${formatItemName(k, true)}
                            </label>
                            <input type="text" inputmode="numeric" id="price_${safeKey}" data-key="${k}" class="calc-input price-input-format opt-b-price" value="0" placeholder="Price to buy direct...">
                        </div>
                    `);
                });

                strictlyRawKeys.forEach(k => {
                    let safeKey = k.replace(/[^a-zA-Z0-9]/g, '');
                    $('#dynamicRawPrices').append(`
                        <div class="form-group" style="margin-bottom:0;">
                            <label style="font-size: 0.85rem; display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                ${formatItemName(k, true)}
                            </label>
                            <input type="text" inputmode="numeric" id="price_${safeKey}" data-key="${k}" class="calc-input price-input-format opt-a-price" value="0">
                        </div>
                    `);
                });
            }

            if (directKeys.length === 0) $('#marketDirectItemsWrapper').hide();
            else $('#marketDirectItemsWrapper').show();

            if (strictlyRawKeys.length === 0) $('#marketRawItemsWrapper').hide();
            else $('#marketRawItemsWrapper').show();

            let requiresBaseGear = prepared_dir['Base Gear (Before Refining)'] || false;
            if (requiresBaseGear) $('#wrapBaseGear').show();
            else { $('#wrapBaseGear').hide(); $('#priceBase').val('0'); }

            let pBase = parseInt($('#priceBase').val().replace(/,/g, '')) || 0;
            let baseGearCount = prepared_dir['Base Gear (Before Refining)'] || 0;
            let baseGearZeny = baseGearCount * pBase;
            let npcRefineZeny = prepared_dir['NPC Refine Fee (Zeny)'] || 0;

            // Option B Math
            let optB_MatsCost = 0;
            let optionB_Valid = true; 
            directKeys.forEach(k => {
                let safeKey = k.replace(/[^a-zA-Z0-9]/g, '');
                let price = parseInt($('#price_' + safeKey).val().replace(/,/g, '')) || 0;
                if (price === 0) optionB_Valid = false; 
                optB_MatsCost += prepared_dir[k] * price;
            });
            let optB_BaseZeny = (prepared_dir['Zeny'] || 0) + npcRefineZeny + baseGearZeny;
            let optB_Total = optB_BaseZeny + optB_MatsCost;

            // Option A Math
            let optA_MatsCost = 0;
            rawKeys.forEach(k => {
                let safeKey = k.replace(/[^a-zA-Z0-9]/g, '');
                let price = parseInt($('#price_' + safeKey).val().replace(/,/g, '')) || 0;
                optA_MatsCost += total_raw[k] * price;
            });
            let craftingFeeZeny = total_raw['Zeny'] || 0; 
            let optA_TotalRawZeny = craftingFeeZeny + npcRefineZeny + baseGearZeny;
            let optA_Total = optA_TotalRawZeny + optA_MatsCost;

            // Breakdown UI
            $('#optA_Total').text(optA_Total.toLocaleString() + ' z');
            $('#optA_Breakdown').html(`
                <div style="display:flex; justify-content:space-between;"><span>Crafting Zeny Fee:</span> <span>${craftingFeeZeny.toLocaleString()} z</span></div>
                <div style="display:flex; justify-content:space-between;"><span>NPC Refine Fee:</span> <span>${npcRefineZeny.toLocaleString()} z</span></div>
                ${baseGearCount > 0 ? `<div style="display:flex; justify-content:space-between;"><span>Base Gear Replace:</span> <span>${baseGearZeny.toLocaleString()} z</span></div>` : ''}
                <div style="display:flex; justify-content:space-between; font-weight:bold; margin-top:4px; padding-top:4px; border-top:1px solid #ddd;"><span>Raw Market Items:</span> <span>${optA_MatsCost.toLocaleString()} z</span></div>
            `);
            
            if (optionB_Valid && directKeys.length > 0) {
                $('#optB_Total').text(optB_Total.toLocaleString() + ' z');
                let optBCraftingFee = prepared_dir['Zeny'] || 0;
                $('#optB_Breakdown').html(`
                    ${optBCraftingFee > 0 ? `<div style="display:flex; justify-content:space-between;"><span>Partial Craft Fee:</span> <span>${optBCraftingFee.toLocaleString()} z</span></div>` : ''}
                    <div style="display:flex; justify-content:space-between;"><span>NPC Refine Fee:</span> <span>${npcRefineZeny.toLocaleString()} z</span></div>
                    ${baseGearCount > 0 ? `<div style="display:flex; justify-content:space-between;"><span>Base Gear Replace:</span> <span>${baseGearZeny.toLocaleString()} z</span></div>` : ''}
                    <div style="display:flex; justify-content:space-between; font-weight:bold; margin-top:4px; padding-top:4px; border-top:1px solid #ddd;"><span>Direct Market Items:</span> <span>${optB_MatsCost.toLocaleString()} z</span></div>
                `);

                if (optA_Total <= optB_Total) {
                    $('#optA_box').css({'border-color': 'var(--success-color)', 'background': 'var(--success-bg)'});
                    $('#optB_box').css({'border-color': 'var(--border-color)', 'background': 'var(--card-bg)'});
                } else {
                    $('#optB_box').css({'border-color': 'var(--success-color)', 'background': 'var(--success-bg)'});
                    $('#optA_box').css({'border-color': 'var(--border-color)', 'background': 'var(--card-bg)'});
                }
            } else {
                $('#optB_Total').text('N/A');
                $('#optB_Breakdown').html(`<div style="margin-top:10px;">(Missing market price for Direct materials)</div>`);
                $('#optA_box').css({'border-color': 'var(--success-color)', 'background': 'var(--success-bg)'});
                $('#optB_box').css({'border-color': 'var(--border-color)', 'background': 'var(--card-bg)'});
            }
        }

        $('#logContainer').html(`
            <div style="margin-bottom: 10px; font-weight: bold; color: var(--muhro-blue);">
                Calculating journey from +${currentRefine} to +${target}:
            </div>
            ${log.join('')}
        `);
        $('#calculatorUI').fadeIn();
    }

    function renderError(msg) {
        $('#directMaterialsContainer').html(`<div class="error-message">${msg}</div>`);
        $('#rawMaterialsContainer').empty();
        $('#rawCol').hide();
        $('#compareContainer').hide();
        $('#logContainer').empty();
        $('#calculatorUI').fadeIn();
    }

    function buildHTMLList(dataObj) {
        let keys = Object.keys(dataObj).sort((a,b) => {
            let aIsZeny = a.includes('Zeny') || a.includes('Fee');
            let bIsZeny = b.includes('Zeny') || b.includes('Fee');
            
            if (a.includes('Base Gear') && !b.includes('Base Gear')) return -1;
            if (b.includes('Base Gear') && !a.includes('Base Gear')) return 1;
            if (aIsZeny && !bIsZeny) return 1;
            if (bIsZeny && !aIsZeny) return -1;
            
            return a.localeCompare(b);
        });
        
        let html = '';
        let hasData = false;
        
        keys.forEach(k => {
            if (k === 'Refine Attempt') return; 
            
            let val = dataObj[k];
            if (val <= 0) return; 
            
            hasData = true;
            let valStr = '';
            
            if (k.includes('Zeny') || k.includes('Fee')) {
                valStr = Math.round(val).toLocaleString() + ' z';
            } else {
                valStr = val.toLocaleString(); 
            }
            
            let displayItem = '';
            if (k === 'Zeny') displayItem = `<div class="material-name-container" style="font-weight: 700;">Material Crafting Fee (Zeny)</div>`;
            else if (k.includes('Fee')) displayItem = `<div class="material-name-container" style="font-weight: 700;">${k}</div>`;
            else displayItem = `<div class="material-name-container">${formatItemName(k, true)}</div>`;
            
            html += `
                <div class="material-row">
                    ${displayItem}
                    <div style="font-weight: bold; color: var(--muhro-accent); margin-left: 10px; text-align: right; min-width: 60px;">${valStr}</div>
                </div>
            `;
        });
        
        if(!hasData) html = "<div style='padding: 10px; color: var(--text-muted);'>No materials needed.</div>";
        return html;
    }

    function renderLists(prepared_dir, total_raw) {
        $('#directMaterialsContainer').html(buildHTMLList(prepared_dir));
        $('#rawMaterialsContainer').html(buildHTMLList(total_raw));
    }
</script>

</body>
</html>